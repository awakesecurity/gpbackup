## ######################################################################
##            ___   ___    _  _  ___ _____   ___ ___ ___ _____
##           |   \ / _ \  | \| |/ _ \_   _| | __|   \_ _|_   _|
##           | |) | (_) | | .` | (_) || |   | _|| |) | |  | |
##           |___/ \___/  |_|\_|\___/ |_|   |___|___/___| |_|
##            _____ _  _ ___ ___   ___ ___ _    ___ _
##           |_   _| || |_ _/ __| | __|_ _| |  | __| |
##             | | | __ || |\__ \ | _| | || |__| _||_|
##             |_| |_||_|___|___/ |_| |___|____|___(_)
##
## This is a generated file. Please edit the corresponding template
## file (example: templates/gpbackup-tpl.yml) and regenerate the pipeline
## using appropriate tool (example: gen_pipeline.py -p gpbackup-release).
## ----------------------------------------------------------------------
## Generated by gen_pipeline.py at: 2019-10-22 11:44:35.975955
## Template file: gpbackup-tpl.yml
## Pipeline Name: gpbackup
## Nightly Trigger: True
## Is Prod: True
## ======================================================================
---
groups:
- name: All
  jobs:
  - build_binaries
  - GPDB6

##### Anchors #####

resource_types:
- name: gcs
  type: docker-image
  source:
    repository: frodenas/gcs-resource

resources:
##### Docker Images #####
- name: centos6-image
  type: docker-image
  source:
    repository: pivotaldata/centos-gpdb-dev
    tag: '6-gcc6.2-llvm3.7'

- name: ubuntu-debian-image
  type: docker-image
  source:
    repository: pivotaldata/gpdb6-ubuntu18.04-test
    tag: 'latest'

##### Other Resources #####
# TODO mark these as src with name change
- name: gpbackup
  type: git
  icon: github-circle
  source:
    uri: https://github.com/greenplum-db/gpbackup
    branch: {{gpbackup-git-branch}}

- name: gpbackup_s3_plugin
  type: git
  icon: github-circle
  source:
    branch: master
    uri: https://github.com/greenplum-db/gpbackup-s3-plugin

- name: gpbackup_ddboost_plugin
  type: git
  icon: github-circle
  source:
    branch: master
    private_key: {{gpbackup-ddboost-plugin-remote-key}}
    uri: {{gpbackup-ddboost-plugin-git-remote}}

- name: gpbackup_manager_src
  type: git
  icon: github-circle
  source:
    branch: master
    private_key: {{gp-backup-manager-remote-deploy-key}}
    uri: {{gp-backup-manager-git-remote}}

- name: gpdb6_src
  type: git
  icon: github-circle
  source:
    uri: https://github.com/greenplum-db/gpdb
    branch: 6X_STABLE

- name: gpbackup-dependencies
  type: s3
  icon: amazon
  source:
      bucket: gpbackup-dependencies
      versioned_file: gpbackup-dependencies/dependencies.tar.gz
      region_name: us-west-2
      access_key_id: {{bucket-access-key-id}}
      secret_access_key: {{bucket-secret-access-key}}

- name: bin_gpdb_6x_stable_centos6
  type: gcs
  icon: google
  source:
      bucket: ((gcs-bucket))
      json_key: ((concourse-gcs-resources-service-account-key))
      regexp: server/published/gpdb6/server-rc-(.*)-rhel6_x86_64((rc-build-type-gcs)).tar.gz

- name: bin_gpdb_6x_stable_ubuntu
  type: gcs
  icon: google
  source:
    bucket: ((gcs-bucket))
    json_key: ((concourse-gcs-resources-service-account-key))
    regexp: server/published/gpdb6/server-rc-(.*)-ubuntu18.04_x86_64((rc-build-type-gcs)).tar.gz

- name: dummy_seclabel_linux_gpdb6
  type: gcs
  icon: google
  source:
    bucket: dummy_seclabel_gpdb_linux
    json_key: ((gcp_svc_acct_key))
    regexp: dummy_seclabel_gpdb6-v(.*).so

- name: debian_gppkgs
  type: s3
  icon: amazon
  source:
    access_key_id: {{bucket-access-key-id}}
    bucket: {{gpdb-stable-bucket-name}}
    region_name: {{aws-region}}
    secret_access_key: {{bucket-secret-access-key}}
    versioned_file: debian_gppkgs/intermediate/gpbackup-gppkgs.tar.gz

- name: pivnet_release_cache
  type: s3
  icon: amazon
  source:
    access_key_id: {{bucket-access-key-id}}
    bucket: {{pivnet_bucket_name}}
    region_name: {{aws-region}}
    secret_access_key: {{bucket-secret-access-key}}
    regexp: pivnet_release_version/v-(.*)

jobs:
- name: build_binaries
  plan:
  - aggregate:
    - get: centos6-image
    - get: gpdb6_src
    - get: gpbackup-dependencies
    - get: bin_gpdb_6x_stable_centos6
    - get: bin_gpdb_6x_stable_ubuntu
    - get: pivnet_release_cache
    - get: gpbackup_ddboost_plugin
      trigger: true
    - get: gpbackup_s3_plugin
      trigger: true
    - get: gpbackup_manager_src
      trigger: true
    - get: gpbackup
      trigger: true
  - aggregate:
    - do:
      - task: build-go-binaries
        image: centos6-image
        file: gpbackup/ci/tasks/build-go-binaries.yml
      - put: gpbackup-dependencies
        params:
          file: output_deps/dependencies.tar.gz
    - task: build-ddboost-RHEL
      config:
        platform: linux
        inputs:
          - name: gpbackup_ddboost_plugin
          - name: bin_gpdb_6x_stable_centos6
        outputs:
          - name: ddboost_components
        image_resource:
          type: docker-image
          source:
            repository: pivotaldata/centos-gpdb-dev
            tag: '6-gcc6.2-llvm3.7'
        run:
          path: bash
          args:
          - -c
          - |
            set -ex

            # Install gpdb binaries
            # This is required because ddboost has a dependency on libpq-fe.h
            mkdir -p /usr/local/greenplum-db-devel
            tar -xzf bin_gpdb_6x_stable_centos6/*.tar.gz -C /usr/local/greenplum-db-devel
            source /usr/local/greenplum-db-devel/greenplum_path.sh

            # build ddboost plugin
            pushd gpbackup_ddboost_plugin
              make build
              ddboost_plugin_version=`git describe --tags | perl -pe 's/(.*)-([0-9]*)-(g[0-9a-f]*)/\1+dev.\2.\3/'`
            popd

            echo ${ddboost_plugin_version} > ddboost_components/ddboost_plugin_version
            cp gpbackup_ddboost_plugin/gpbackup_ddboost_plugin ddboost_components/
            cp gpbackup_ddboost_plugin/DDBoostSDK/lib/release/linux/64/libDDBoost.so ddboost_components/
  - task: tar-binaries-RHEL
    config:
      platform: linux
      inputs:
        - name: go_components
        - name: ddboost_components
      outputs:
        - name: github_release_components
      image_resource:
        type: docker-image
        source:
          repository: pivotaldata/centos-gpdb-dev
          tag: '6-gcc6.2-llvm3.7'
      run:
        path: bash
        args:
        - -c
        - |
          set -ex
          pushd github_release_components
            # Create install script
            printf "#!/bin/sh\nset -x\ntar -xzvf bin_gpbackup.tar.gz -C \$GPHOME" > install_gpdb_component
            chmod +x install_gpdb_component

            cp ../go_components/*_version .
            mv ../go_components/gpbackup_version version
            cp ../ddboost_components/*_version .

            mkdir -p bin
            cp ../go_components/gpbackup bin/
            cp ../go_components/gpbackup_helper bin/
            cp ../go_components/gprestore bin/
            cp ../go_components/gpbackup_s3_plugin bin/
            cp ../go_components/gpbackup_manager bin/
            cp ../ddboost_components/gpbackup_ddboost_plugin bin/

            mkdir -p lib
            cp ../ddboost_components/libDDBoost.so lib/

            tar -czvf bin_gpbackup.tar.gz bin/ lib/

            version=`cat version`
            tar -czvf "gpbackup-${version}.tar.gz" bin_gpbackup.tar.gz install_gpdb_component gpbackup_version version s3_plugin_version ddboost_plugin_version gpbackup_manager_version
          popd
  - task: build-debian-packages
    file: gpbackup/ci/tasks/create-debian-packages.yml
    input_mapping:
      gpdb_src: gpdb6_src
      bin_gpdb: bin_gpdb_6x_stable_ubuntu
  - put: debian_gppkgs
    params:
      file: debian_gppkgs/gpbackup-gppkgs.tar.gz

- name: GPDB6
  plan:
  - in_parallel:
    - get: gpbackup
#      passed: [build_binaries]
    - get: gpbackup-dependencies
      passed: [build_binaries]
    - get: debian_gppkgs
      trigger: true
      passed: [build_binaries]
    - get: ubuntu-debian-image
    - get: gpdb_src
      resource: gpdb6_src
    - get: dummy_seclabel
      resource: dummy_seclabel_linux_gpdb6
    - get: bin_gpdb_6x_stable_ubuntu
  - task: run-tests-locally-ubuntu-debian
    image: ubuntu-debian-image
    file: gpbackup/ci/tasks/test-on-local-cluster-ubuntu.yml
    params:
      REQUIRES_DUMMY_SEC: true
    input_mapping:
      bin_gpdb: bin_gpdb_6x_stable_ubuntu
      gppkgs: debian_gppkgs
